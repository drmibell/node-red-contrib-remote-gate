# node-red-contrib-remote-gate
A set of Node-RED nodes for remotely controlling message flow, consisting of a gate node and remote-control node.

## Install

Either use the Manage Palette selection in the Node-RED Editor menu, or run the following command in your Node-RED user directory (typically `~/.node-red`):

    npm install node-red-contrib-remote-gate

## Usage

The `rc-gate` node will transmit the input message to its output when in the `open` state and block it when `closed`. Its state is controlled remotely by one or more `gate-ctrl`nodes. Messages that arrive when the gate is `closed` are discarded. If it is desired to save those messages for future delivery, the `q-gate` node, published as [node-red-contrib-queue-gate](https://flows.nodered.org/node/node-red-contrib-queue-gate) is available, although without the remote-control feature.


Control messages are received by `rc-gate` nodes from `gate-ctrl` nodes via a publish/subscribe mechanism based on `node.js` events. These messages set the state of the gate and can have values representing `open`, `close`, `toggle`, and `default`. Except for this remote-control feature, operation of the `rc-gate` is identical to that of the `gate` node published as [node-red-contrib-simple-gate](https://flows.nodered.org/node/node-red-contrib-simple-gate). The (case-insensitive) strings representing the commands are set by the user when the `rc-gate` node is deployed. If a control message is received but not recognized, there is no output or change of state, and the node reports an error. When first deployed or after a `default` command, the gate is in the user-selected state defined by `Default State` (see below regarding persistence).

An `rc-gate` node can be controlled by any `gate-ctrl` node on any tab. Connections between the `rc-gate` and `gate-ctrl` nodes are established through the `Topic` definitions of each node. Nodes with matching topics are connected, and every `rc-gate` node is automatically subscribed to the topic `all` as well as to the topic defined in its own edit dialog. This makes it possible to both set the state of many gates simultaneously and control them individually. The `gate-ctrl` node also has a `Use message topic` option (checkbox) that allows it to obtain its topic from the incoming message. 

## Node status
The state of the gate is indicated by a status object: text and either a green dot (`open`) or a red ring (`closed`).

## State persistence
By default, the node enters the `Default State` on startup, either when first deployed in the editor, re-deployed as part of a modified flow or entire workspace, or when Node-RED is restarted by the user or by a system service. The user can, however, select the `Restore from saved state` option (checkbox) in the edit dialog. Then, if a persistent form of context storage has been enabled in the Node-RED `settings.js` file, the node will attempt to enter the state last saved in the node context and will use the `Default State` only if no saved state is available.

## Caution
These nodes should be used with care, since they can make flows difficult to debug or modify. By passing control messages directly between `gate-ctrl` and `rc-gate` nodes, they violate a basic design principle of Node-RED: that nodes communicate by passing messages along wires. As an aid to tracing the flow of control messages, each node will display its `Topic` in the editor if its `Name` is left blank. This can be seen by deleting the node names in either of the examples below. 

Future versions of Node-RED will probably continue to support the communication mechanism used by these nodes, but it is not likely that they will be able to take advantage of any new mechanisms introduced for exchanging messages between multiple instances of Node-RED or with other modules.

## Limitations
A flow or project (set of tabs) can contain as many `rc-gate` nodes as desired, but adding 
gates beyond a total of 15 will cause a warning message (`MaxListenersExceededWarning`) to be logged. This is a feature of `node.js` intended to detect memory leaks, and can be disregarded unless it occurs with a smaller number of gates or appears during execution of the flow. The limit has already been increased from its default value (corresponding to 5 gates), but it can be increased further or removed altogether in future versions if the warnings prove troublesome. 

These nodes can be used in subflows, but each instance of the subflow will behave identically, since it is not currently possible to assign a distinct `Topic` to the nodes in each instance. Also an `rc-gate` in a subflow has no way to indicate its status in the editor at this time.

## Examples
### Basic Operation
This flow demonstrates the basic operation of the `rc-gate` and `gate-ctrl` nodes.

```
[{"id":"816530eb.d794a","type":"inject","z":"871d5880.4acb8","name":"","topic":"","payload":"open","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":220,"wires":[["c4d2584.7bc1aa8"]]},{"id":"f0271eae.78db88","type":"debug","z":"871d5880.4acb8","name":"output 1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":440,"y":40,"wires":[]},{"id":"339035f.b8abe4a","type":"debug","z":"871d5880.4acb8","name":"output 2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":440,"y":100,"wires":[]},{"id":"888e93a4.d65e","type":"debug","z":"871d5880.4acb8","name":"output 3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":440,"y":160,"wires":[]},{"id":"53143c3a.12113c","type":"inject","z":"871d5880.4acb8","name":"open","topic":"two","payload":"open","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":430,"y":220,"wires":[["5d2b1783.01ea"]]},{"id":"b9065e1c.6822f","type":"inject","z":"871d5880.4acb8","name":"close","topic":"control","payload":"close","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":430,"y":260,"wires":[["5d2b1783.01ea"]]},{"id":"ba668df3.f078e","type":"inject","z":"871d5880.4acb8","name":"toggle","topic":"control","payload":"toggle","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":430,"y":300,"wires":[["5d2b1783.01ea"]]},{"id":"efbe7b1b.5eb3d8","type":"inject","z":"871d5880.4acb8","name":"reset","topic":"control","payload":"default","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":430,"y":340,"wires":[["5d2b1783.01ea"]]},{"id":"3d0d1f75.48c8d","type":"inject","z":"871d5880.4acb8","name":"input","topic":"input message","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":100,"wires":[["c99f67ea.ffa098","23366c2.4606e14","7acdce48.388678"]]},{"id":"4067dadb.18dbd4","type":"inject","z":"871d5880.4acb8","name":"","topic":"","payload":"close","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":260,"wires":[["c4d2584.7bc1aa8"]]},{"id":"48206e31.32d56","type":"inject","z":"871d5880.4acb8","name":"toggle","topic":"control","payload":"toggle","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":300,"wires":[["79794b85.7e9e8c"]]},{"id":"c2adbbe8.eb5b4","type":"inject","z":"871d5880.4acb8","name":"reset","topic":"control","payload":"default","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":340,"wires":[["79794b85.7e9e8c"]]},{"id":"c99f67ea.ffa098","type":"rc-gate","z":"871d5880.4acb8","name":"gate 1","topic":"one","defaultState":"open","openCmd":"open","closeCmd":"close","toggleCmd":"toggle","defaultCmd":"default","persist":false,"x":290,"y":40,"wires":[["f0271eae.78db88"]]},{"id":"23366c2.4606e14","type":"rc-gate","z":"871d5880.4acb8","name":"gate 2","topic":"two","defaultState":"open","openCmd":"open","closeCmd":"close","toggleCmd":"toggle","defaultCmd":"default","persist":false,"x":290,"y":100,"wires":[["339035f.b8abe4a"]]},{"id":"7acdce48.388678","type":"rc-gate","z":"871d5880.4acb8","name":"gate 3","topic":"three","defaultState":"open","openCmd":"open","closeCmd":"close","toggleCmd":"toggle","defaultCmd":"default","persist":false,"x":290,"y":160,"wires":[["888e93a4.d65e"]]},{"id":"c4d2584.7bc1aa8","type":"gate-ctrl","z":"871d5880.4acb8","name":"control 1","topic":"one","useMsgTopic":false,"x":260,"y":240,"wires":[]},{"id":"79794b85.7e9e8c","type":"gate-ctrl","z":"871d5880.4acb8","name":"control 2","topic":"two","useMsgTopic":false,"x":260,"y":320,"wires":[]},{"id":"5d2b1783.01ea","type":"gate-ctrl","z":"871d5880.4acb8","name":"control all","topic":"all","useMsgTopic":false,"x":600,"y":280,"wires":[]}]
```
<img src="https://github.com/drmibell/node-red-contrib-remote-gate/blob/master/screenshots/basic-operation.png?raw=true"/>


### Complex Control
This flow indicates how the `Use message topic` option of the `gate-ctl` node can be used to produce complex sequences of states for a large number of gates. The `function` node steps through each of the possible permutions of `open` and `closed` states for the three nodes it controls, switching states each time it receives an input message.

```
[{"id":"28da2828.690f68","type":"debug","z":"c4efa908.b55df8","name":"output 1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":420,"y":60,"wires":[]},{"id":"7a7262df.a41524","type":"debug","z":"c4efa908.b55df8","name":"output 2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":420,"y":120,"wires":[]},{"id":"64ddd257.0d32a4","type":"debug","z":"c4efa908.b55df8","name":"output 3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":420,"y":180,"wires":[]},{"id":"408e81b9.58fa7","type":"inject","z":"c4efa908.b55df8","name":"input","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":120,"wires":[["7385e9a4.75c29","fadeeba1.a9705","9e724559.af75f8"]]},{"id":"2ffc2835.61a978","type":"function","z":"c4efa908.b55df8","name":"cycle","func":"var n = context.get('count') || 0;\ncontext.set('count',(n+1));\nvar arr = [Boolean((n&4)!==0),Boolean((n&2)!==0),Boolean((n&1)!==0)];\nvar msgs = [{topic:1,payload:arr[0]?'open':'close'},\n{topic:2,payload:arr[1]?'open':'close'},\n{topic:3,payload:arr[2]?'open':'close'}];\nreturn [msgs];\n","outputs":1,"noerr":0,"x":270,"y":260,"wires":[["f1caf6d5.b0822"]]},{"id":"a8385e87.ee93c8","type":"inject","z":"c4efa908.b55df8","name":"trigger","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":260,"wires":[["2ffc2835.61a978"]]},{"id":"7385e9a4.75c29","type":"rc-gate","z":"c4efa908.b55df8","name":"gate 1","topic":"1","defaultState":"open","openCmd":"open","closeCmd":"close","toggleCmd":"toggle","defaultCmd":"default","persist":false,"x":270,"y":60,"wires":[["28da2828.690f68"]]},{"id":"fadeeba1.a9705","type":"rc-gate","z":"c4efa908.b55df8","name":"gate 3","topic":"3","defaultState":"open","openCmd":"open","closeCmd":"close","toggleCmd":"toggle","defaultCmd":"default","persist":false,"x":270,"y":180,"wires":[["64ddd257.0d32a4"]]},{"id":"f1caf6d5.b0822","type":"gate-ctrl","z":"c4efa908.b55df8","name":"control","topic":"","useMsgTopic":true,"x":410,"y":260,"wires":[]},{"id":"9e724559.af75f8","type":"rc-gate","z":"c4efa908.b55df8","name":"gate 2","topic":"2","defaultState":"open","openCmd":"open","closeCmd":"close","toggleCmd":"toggle","defaultCmd":"default","persist":false,"x":270,"y":120,"wires":[["7a7262df.a41524"]]}]
```

<img src="https://github.com/drmibell/node-red-contrib-remote-gate/blob/master/screenshots/complex-control.png?raw=true"/>
